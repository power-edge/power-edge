name: Pre-Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  create-pre-release:
    name: Create Pre-Release
    runs-on: ubuntu-latest
    # Only run on merges (not direct pushes)
    if: github.event.head_commit.message != github.event.head_commit.id

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate pre-release version
        id: version
        run: |
          # Get latest tag or default to v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Generate pre-release version: {latest-tag}-pre.{commit-count}+{short-sha}
          COMMIT_COUNT=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          PRE_VERSION="${LATEST_TAG}-pre.${COMMIT_COUNT}+${SHORT_SHA}"

          echo "version=$PRE_VERSION" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Pre-release version: $PRE_VERSION"

      - name: Build artifacts
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GIT_COMMIT: ${{ github.sha }}
        run: |
          make generate
          make build

          # Create distribution
          mkdir -p dist
          cp bin/power-edge dist/
          tar -czf dist/power-edge-${{ steps.version.outputs.version }}-linux-amd64.tar.gz \
            -C dist power-edge

      - name: Build Docker image
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push pre-release Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/power-edge/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}:pre-latest
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog since last tag
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"

          echo "## Pre-Release Build" > changelog.md
          echo "" >> changelog.md
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> changelog.md
          echo "**Commit:** \`${{ github.sha }}\`" >> changelog.md
          echo "**Based on:** \`${LATEST_TAG}\`" >> changelog.md
          echo "" >> changelog.md
          echo "### Changes since ${LATEST_TAG}" >> changelog.md
          echo "" >> changelog.md

          if [ "$LATEST_TAG" != "v0.0.0" ]; then
            git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" >> changelog.md
          else
            echo "- Initial development build" >> changelog.md
          fi

          echo "" >> changelog.md
          echo "" >> changelog.md
          echo "---" >> changelog.md
          echo "" >> changelog.md
          echo "**âš ï¸ This is a pre-release build for testing purposes.**" >> changelog.md
          echo "" >> changelog.md
          echo "Docker: \`ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}\`" >> changelog.md

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Pre-Release ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: dist/*.tar.gz
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PRs
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const sha = '${{ github.sha }}';

            // Find merged PRs in this push
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha
            });

            // Look for PR number in commit message
            const prMatch = commit.data.commit.message.match(/#(\d+)/);

            if (prMatch) {
              const prNumber = parseInt(prMatch[1]);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ðŸš€ Pre-Release Created

This PR has been merged and a pre-release build is now available:

**Version:** \`${version}\`
**Docker:** \`ghcr.io/${context.repo.owner}/${context.repo.repo}:${version}\`

You can test this build before creating an official release.`
              });
            }

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Pre-Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker: \`ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Tarball: Available in GitHub release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Testing" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull pre-release Docker image" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or use pre-latest tag" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:pre-latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
