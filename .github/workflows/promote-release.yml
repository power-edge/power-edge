name: Promote to Release

on:
  workflow_dispatch:
    inputs:
      pre_release_version:
        description: 'Pre-release version to promote (e.g., v0.0.0-pre.123+abc1234)'
        required: true
        type: string
      release_version:
        description: 'New release version (e.g., v1.2.3)'
        required: true
        type: string
      is_rollback:
        description: 'Is this a rollback to a previous version?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  validate-promotion:
    name: Validate Promotion
    runs-on: ubuntu-latest
    outputs:
      pre_release_sha: ${{ steps.validate.outputs.sha }}
      can_promote: ${{ steps.validate.outputs.can_promote }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        id: validate
        run: |
          PRE_VERSION="${{ inputs.pre_release_version }}"
          NEW_VERSION="${{ inputs.release_version }}"
          IS_ROLLBACK="${{ inputs.is_rollback }}"

          echo "üîç Validating promotion request..."
          echo "  Pre-release: $PRE_VERSION"
          echo "  New version: $NEW_VERSION"
          echo "  Rollback: $IS_ROLLBACK"
          echo ""

          # Check if pre-release exists
          if ! git rev-parse "$PRE_VERSION" >/dev/null 2>&1; then
            echo "‚ùå Pre-release tag $PRE_VERSION not found"
            exit 1
          fi

          # Get commit SHA from pre-release
          PRE_SHA=$(git rev-parse "$PRE_VERSION")
          echo "sha=$PRE_SHA" >> $GITHUB_OUTPUT
          echo "‚úì Pre-release commit: $PRE_SHA"

          # Validate new version format
          if ! echo "$NEW_VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "‚ùå Invalid release version format: $NEW_VERSION"
            echo "   Expected: vMAJOR.MINOR.PATCH (e.g., v1.2.3)"
            exit 1
          fi
          echo "‚úì Valid version format: $NEW_VERSION"

          # Check if release version already exists
          if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
            echo "‚ùå Release tag $NEW_VERSION already exists"
            exit 1
          fi
          echo "‚úì Version $NEW_VERSION is available"

          # If rollback, check if we're going backwards
          if [ "$IS_ROLLBACK" = "true" ]; then
            LATEST_TAG=$(git describe --tags --abbrev=0 --match="v[0-9]*" 2>/dev/null || echo "v0.0.0")

            # Parse versions for comparison
            LATEST_VER=$(echo "$LATEST_TAG" | sed 's/v//' | awk -F. '{printf "%d%03d%03d", $1, $2, $3}')
            NEW_VER=$(echo "$NEW_VERSION" | sed 's/v//' | awk -F. '{printf "%d%03d%03d", $1, $2, $3}')

            if [ "$NEW_VER" -ge "$LATEST_VER" ]; then
              echo "‚ö†Ô∏è  Warning: Rollback version ($NEW_VERSION) >= latest ($LATEST_TAG)"
              echo "   This doesn't look like a rollback. Consider unchecking is_rollback."
            else
              echo "‚ö†Ô∏è  ROLLBACK DETECTED: $NEW_VERSION < $LATEST_TAG"
            fi
          fi

          echo "can_promote=true" >> $GITHUB_OUTPUT
          echo ""
          echo "‚úÖ Validation passed - ready to promote"

      - name: Validate version bump (if not rollback)
        if: inputs.is_rollback != true
        run: |
          PRE_VERSION="${{ inputs.pre_release_version }}"
          NEW_VERSION="${{ inputs.release_version }}"

          # Extract commit SHA
          PRE_SHA="${{ steps.validate.outputs.sha }}"

          # Checkout the pre-release commit
          git checkout "$PRE_SHA"

          # Validate version bump matches changes
          chmod +x scripts/build/validate-version.sh
          bash scripts/build/validate-version.sh "$NEW_VERSION" || {
            echo ""
            echo "‚ö†Ô∏è  Version validation failed!"
            echo "   This might be OK if promoting a tested pre-release."
            echo "   Review changes and proceed with caution."
          }

  promote-release:
    name: Promote to Release
    needs: validate-promotion
    if: needs.validate-promotion.outputs.can_promote == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code at pre-release commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-promotion.outputs.pre_release_sha }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Rebuild artifacts with release version
        env:
          VERSION: ${{ inputs.release_version }}
          GIT_COMMIT: ${{ needs.validate-promotion.outputs.pre_release_sha }}
        run: |
          make generate
          make build

          # Create distribution
          mkdir -p dist
          VERSION_NO_V=${VERSION#v}
          tar -czf dist/edge-state-exporter-${VERSION_NO_V}-linux-amd64.tar.gz \
            -C bin edge-state-exporter
          sha256sum dist/*.tar.gz > dist/checksums.txt

      - name: Re-tag Docker image
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull pre-release image and re-tag
        run: |
          PRE_VERSION="${{ inputs.pre_release_version }}"
          NEW_VERSION="${{ inputs.release_version }}"

          # Pull pre-release image
          docker pull ghcr.io/${{ github.repository }}:${PRE_VERSION}

          # Re-tag as release
          docker tag ghcr.io/${{ github.repository }}:${PRE_VERSION} \
                     ghcr.io/${{ github.repository }}:${NEW_VERSION}

          # Also tag as latest if not a rollback
          if [ "${{ inputs.is_rollback }}" != "true" ]; then
            docker tag ghcr.io/${{ github.repository }}:${PRE_VERSION} \
                       ghcr.io/${{ github.repository }}:latest
          fi

          # Push new tags
          docker push ghcr.io/${{ github.repository }}:${NEW_VERSION}

          if [ "${{ inputs.is_rollback }}" != "true" ]; then
            docker push ghcr.io/${{ github.repository }}:latest
          fi

      - name: Generate release notes
        id: notes
        run: |
          PRE_VERSION="${{ inputs.pre_release_version }}"
          NEW_VERSION="${{ inputs.release_version }}"
          IS_ROLLBACK="${{ inputs.is_rollback }}"
          PRE_SHA="${{ needs.validate-promotion.outputs.pre_release_sha }}"

          echo "## Release $NEW_VERSION" > release-notes.md
          echo "" >> release-notes.md

          if [ "$IS_ROLLBACK" = "true" ]; then
            echo "### ‚ö†Ô∏è ROLLBACK RELEASE" >> release-notes.md
            echo "" >> release-notes.md
            echo "**This is a rollback to a previous version.**" >> release-notes.md
            echo "" >> release-notes.md
            echo "**Why rollbacks happen:**" >> release-notes.md
            echo "- Critical bug found in newer version" >> release-notes.md
            echo "- Production incident requiring immediate revert" >> release-notes.md
            echo "- Compatibility issues discovered" >> release-notes.md
            echo "" >> release-notes.md
            echo "**‚ö†Ô∏è Note:** Rollbacks should be temporary. Address root cause and move forward." >> release-notes.md
            echo "" >> release-notes.md
            echo "---" >> release-notes.md
            echo "" >> release-notes.md
          fi

          echo "**Promoted from:** \`${PRE_VERSION}\`" >> release-notes.md
          echo "**Commit:** \`${PRE_SHA}\`" >> release-notes.md
          echo "" >> release-notes.md

          # Get changelog since last release
          PREV_RELEASE=$(git describe --tags --abbrev=0 --match="v[0-9]*" ${NEW_VERSION}^ 2>/dev/null || echo "")

          if [ -n "$PREV_RELEASE" ] && [ "$PREV_RELEASE" != "v0.0.0" ]; then
            echo "### Changes since $PREV_RELEASE" >> release-notes.md
            echo "" >> release-notes.md
            git log ${PREV_RELEASE}..${PRE_SHA} --pretty=format:"- %s (%h)" >> release-notes.md
            echo "" >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "### Artifacts" >> release-notes.md
          echo "" >> release-notes.md
          echo "- üê≥ Docker: \`ghcr.io/${{ github.repository }}:${NEW_VERSION}\`" >> release-notes.md
          echo "- üì¶ Binary: See attachments" >> release-notes.md
          echo "" >> release-notes.md

          if [ "$IS_ROLLBACK" = "true" ]; then
            echo "### Post-Rollback Actions" >> release-notes.md
            echo "" >> release-notes.md
            echo "1. ‚úÖ Verify system stability" >> release-notes.md
            echo "2. üîç Investigate root cause of issues in newer version" >> release-notes.md
            echo "3. üõ†Ô∏è  Fix issues in development branch" >> release-notes.md
            echo "4. ‚úÖ Test thoroughly before next release" >> release-notes.md
            echo "5. üìù Document lessons learned" >> release-notes.md
            echo "" >> release-notes.md
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_version }}
          name: ${{ inputs.is_rollback == 'true' && format('‚ö†Ô∏è Rollback: {0}', inputs.release_version) || format('Release {0}', inputs.release_version) }}
          body: ${{ steps.notes.outputs.notes }}
          files: dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create rollback issue (if rollback)
        if: inputs.is_rollback == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ inputs.release_version }}';
            const preVersion = '${{ inputs.pre_release_version }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è Investigate rollback to ${version}`,
              body: `## Rollback Performed

A rollback release was created: **${version}**

**Rolled back from:** \`${preVersion}\`
**Created by:** @${context.actor}

### Action Items

- [ ] Document what went wrong in newer version
- [ ] Create fix in development branch
- [ ] Add regression tests
- [ ] Plan next release with fix

### Context

Add details about why this rollback was necessary.`,
              labels: ['rollback', 'incident', 'priority:high']
            });

      - name: Summary
        run: |
          NEW_VERSION="${{ inputs.release_version }}"
          IS_ROLLBACK="${{ inputs.is_rollback }}"

          echo "## üéâ Release Promoted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_ROLLBACK" = "true" ]; then
            echo "### ‚ö†Ô∏è ROLLBACK RELEASE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Version:** \`${NEW_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**From:** \`${{ inputs.pre_release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ needs.validate-promotion.outputs.pre_release_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull release Docker image" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${NEW_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or download binary from GitHub release" >> $GITHUB_STEP_SUMMARY
          echo "wget https://github.com/${{ github.repository }}/releases/download/${NEW_VERSION}/edge-state-exporter-*.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_ROLLBACK" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ö†Ô∏è Remember" >> $GITHUB_STEP_SUMMARY
            echo "Rollbacks are **temporary**. Fix the root cause and move forward!" >> $GITHUB_STEP_SUMMARY
          fi
