name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]

jobs:
  # Only run E2E tests on non-draft PRs or main branch pushes
  check-run-conditions:
    name: Check if E2E should run
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check conditions
        id: check
        run: |
          # Run E2E on pushes to main
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Running E2E: Push to main"
            exit 0
          fi

          # Run E2E on non-draft PRs to main
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.pull_request.draft }}" = "false" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "✅ Running E2E: Non-draft PR to main"
              exit 0
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "⏭️  Skipping E2E: Draft PR"
              exit 0
            fi
          fi

          # Skip in all other cases
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "⏭️  Skipping E2E: Conditions not met"

  e2e-integration:
    name: E2E Integration Tests
    needs: check-run-conditions
    if: needs.check-run-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build binary
        run: make build

      - name: Set up test environment
        run: |
          # Create test configs
          mkdir -p /tmp/power-edge-test/config
          cp -r config/nodes/stella-PowerEdge-T420 /tmp/power-edge-test/config/test-node

          # Redact machine IDs for CI
          sed -i 's/primary_id: ".*"/primary_id: "test-machine-id-e2e"/' \
            /tmp/power-edge-test/config/test-node/system-identity.yaml

      - name: Run exporter with test config
        timeout-minutes: 2
        run: |
          # Start exporter in background
          ./bin/power-edge \
            -state-config=/tmp/power-edge-test/config/test-node/state.yaml \
            -watcher-config=/tmp/power-edge-test/config/test-node/watcher.yaml \
            -listen=:9100 \
            -check-interval=5s &

          EXPORTER_PID=$!
          echo "Started exporter with PID: $EXPORTER_PID"

          # Wait for startup
          sleep 3

          # Check if still running
          if ! kill -0 $EXPORTER_PID 2>/dev/null; then
            echo "❌ Exporter crashed on startup"
            exit 1
          fi

          echo "✅ Exporter started successfully"
          echo "exporter_pid=$EXPORTER_PID" >> $GITHUB_ENV

      - name: Test metrics endpoint
        run: |
          # Test /metrics endpoint
          curl -f http://localhost:9100/metrics || {
            echo "❌ Metrics endpoint failed"
            exit 1
          }

          # Verify Prometheus format
          if ! curl -s http://localhost:9100/metrics | grep -q "edge_state_"; then
            echo "❌ No edge_state metrics found"
            exit 1
          fi

          echo "✅ Metrics endpoint working"

      - name: Test health endpoint
        run: |
          HEALTH=$(curl -s http://localhost:9100/health)
          if ! echo "$HEALTH" | grep -q '"status":"healthy"'; then
            echo "❌ Health check failed"
            echo "Response: $HEALTH"
            exit 1
          fi
          echo "✅ Health endpoint OK"

      - name: Test version endpoint
        run: |
          VERSION=$(curl -s http://localhost:9100/version)
          if ! echo "$VERSION" | grep -q '"version"'; then
            echo "❌ Version endpoint failed"
            exit 1
          fi
          echo "✅ Version endpoint OK"
          echo "Version info: $VERSION"

      - name: Verify state checking
        run: |
          # Check metrics for state compliance
          METRICS=$(curl -s http://localhost:9100/metrics)

          # Should have site info metric
          if ! echo "$METRICS" | grep -q "edge_state_info"; then
            echo "❌ Missing site info metric"
            exit 1
          fi

          echo "✅ State checking operational"

      - name: Cleanup
        if: always()
        run: |
          if [ -n "${{ env.exporter_pid }}" ]; then
            kill ${{ env.exporter_pid }} 2>/dev/null || true
          fi

  e2e-docker:
    name: E2E Docker Tests
    needs: check-run-conditions
    if: needs.check-run-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: make docker-build
        env:
          VERSION: e2e-test

      - name: Test Docker container
        run: |
          # Test version command
          docker run --rm power-edge/power-edge:e2e-test -version

          # Test with minimal config (should fail gracefully)
          docker run --rm \
            -e STATE_CONFIG=/dev/null \
            power-edge/power-edge:e2e-test \
            -version || true

          echo "✅ Docker image functional"

  e2e-summary:
    name: E2E Test Summary
    needs: [ e2e-integration, e2e-docker ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.e2e-integration.result }}" != "success" ] || \
             [ "${{ needs.e2e-docker.result }}" != "success" ]; then
            echo "❌ E2E tests failed"
            exit 1
          fi
          echo "✅ All E2E tests passed"
